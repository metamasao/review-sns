# 簡単な自己紹介とレビューSNS作成について

## はじめに
本稿ではまず私は何に興味があるのか、勉強する際にどういったことに注意を払ってきたのかといった簡単な自己紹介を行います。次に私が作成したレビューSNSについて、設計思想から基本的な機能やなぜこのようなアプリケーションを作ったのかという動機、目的を達成するために工夫した点、どのような書籍や記事に基づいて作成したのか説明します。最後に、今回作ったアプリケーションについての反省や、これまで勉強したこと、今後勉強したいことについて述べます。

## 自己紹介
私は統計的学習に当初興味があり勉強していましたが、webに関する基本的知識があまりになさすぎると思い、去年7月頃から勉強し始めたところ、こちらのほうが面白くやりがいを感じるようになり、現在web系エンジニアになるべく独学で勉強しています（「独学」という言葉は巨人の方に乗ることを否定するきらいがあるのであまり好きではありませんが、他の方との差異を強調する可能性があるので使いました）。

また勉強する際には、和書に限定せず洋書も含めて信頼できそうな書籍を探し、それに依拠するまたは公式ドキュメントに基づいて学習を進め、ベストプラクティスに従うようにしました。積極的にDjangoやサードパーティーのコードも見ています。ネットの記事を参考にすることもありますが、その場合もできる限り信頼できる書籍によって参照されているような記事を参考にしました。どのような書籍や記事を参考にしたのかは次節以降に記します。以下、簡単に私が興味のあることを書いています。

- ?

## レビューSNSについて

### 設計思想について
Test以外ではできる限りDRYに従い、ModelやViewを作るときはFat ModelやThin View(Skinny Controller)の方針に従いロジックなどはViewではなくできる限りModel(Managerも含む)に記述しました。また、伝統的なFat Model(属性やメソッドが単純にたくさん定義されたModel)にするのではなく、抽象モデルのMix-inクラスを作成しそれを継承することで、DRYを効率よく達成しようとしました。このようなMix-inクラスうち、とりわけ汎用性が高いのはcoreアプリに、各アプリに依存性が高いMix-inクラスは各アプリで書くようにしました。

テストではDRYの方針に従わず同じようなコードを何度も書くようにしました。これはテストコードそれ自体がテストの必要があるコードになるのを防ぐためです。さらに、test.Clientではmiddlewareやurlsへの依存性が高く、そのためviewを直接検証できない、テストが遅くなるという問題があるので、できる限りtest.RequestFactoryを使うようにしました。

### なぜ書評SNSを作ったか
私だけではないと思いますが、次のような問題に頭を悩ませるひとがいると思います。「ある分野の入門書を探してるけど、何が最適なテキストなのかわからない」「とりあえず入門書を1冊読んだけど、次に何を読めばいいのかわからない」。このような困難を少しでも克服できるようなSNSを作りたい。このような動機から本アプリケーションを作成しました。

### アプリケーションの概要

![概要](picture_for_readme/overview.gif)

本アプリケーションでは、会員登録後に、本の登録（OpenBDのAPIから本の情報を取得）、ある本についてのレビューの作成、ユーザーフォローと「いいね」（Axiosを用いた非同期通信）ができ、フォローしたユーザの活動（誰をフォローしたか、どのレビューをいいねしたか）も確認できます。レビューを作成する場合には次の本を指定し推薦文を書くことが必須となっており、こうすることで次に何を読めばいいのかという問題を解消しようと努めました。

開発環境の構築に関しては、本番環境でのOSが異なることで生じる不具合や異なるデータベースを用いることで生じるマイグレーションファイルの不具合に対処するためにDockerを用いました。Herokuにてデプロイしましたが、コードを公開しつつアプリケーションを運用するのはセキュリティ上のリスクを犯すことになるのでストップし、代わりにgifをここに貼っています。

本の登録
![本の登録](picture_for_readme/ajax_book_create.gif)

ユーザーフォロー
![ユーザーフォロー](picture_for_readme/ajax_user_follow.gif)

いいね
![いいね](picture_for_readme/ajax_review_like.gif)

フォローしてるユーザーの活動
![フォローしてるユーザーの活動](picture_for_readme/action.gif)

### 各アプリの機能や工夫したところ

#### Account

- 会員登録
- プロフィール編集
- ユーザーフォロー(axiosを用いた非同期通信)
- ユーザー追跡機能(フォローやいいねを記録する)
- superuser以外のアカウントが管理画面(admin)にリクエストを送ると、403(権限がない)を返すようにしてます。
- とりわけ工夫したのは、ユーザーの活動を記録するModelとManagerです。「フォロー」はCustomUserモデル、「いいね」はReviewモデルと異なるタイプのモデルなので、GenericForeignKeyを使うことも可能でしたが("Django 3 by Exmaple"では実際にそのように実装されていましたが)、"Two Scoops of Django"の著者によると、クエリのスピードが低下すること、データが壊れる可能性があることから、そのように実装することはしませんでした。また、活動を記録するロジックはモデル(マネージャー)に書き、Thin Viewにすることで、見やすくしています。
- ユーザーフォローする場合にAjaxを使うため、リクエストヘッダーフィールドのx-requested-withがXMLHttpRequestではないリクエストや、csrfトークンなしでのリクエストに対してきちんと対処できてるかどうか主にテストでは検証しました。

#### Book

- 本の登録(簡単な情報についてOpenBDのAPIを利用)
- 本の詳細な情報(axiosを用いてOpenBDより非同期通信で取得)
- 書名や著者名に基づく検索
- カテゴリーによる分類
- ページネーション
- 書籍の簡単な情報はOpenBDより取得していますが、何が問題があった場合(レスポンスのステータスコードが200番台以外の場合)にはSentryでログを拾い、メールにて通知するようにしています。本当はSlackに通知したいのですが。
- テストするときにはAPIを利用するわけにはいかないので、unittestのモックオブジェクトを使いました。

#### core

- ここでDRYやFat Model, Thin View(Skinny Controller)の方針を満たすための特に汎用性の高いコードを書いています。セキュリティ上の観点から単調増加キーではなくUUIDフィールドを主キーとして用いたUUIDModel、UUIDModelベースのUUIDURLModel、PublishModel、SearchResultMixinなどなどがあります。

#### Review

- レビューのCRUD機能
- レビューへのコメント、いいね機能
- ページネーション
- 特定の著者や本に紐づけられたレビュー一覧はここにReviewDetailMixinを作り、ListViewにそれを継承することで繰り返しを避けるようにしました。 

#### 本アプリケーションを構築する際に参考にした書籍や記事

##### 書籍

- 横瀬　明仁、『現場で使えるDJANGOの教科書　<実践編>』
- Vincent, Williams S. , "Django for Beginners"
- Vincent, Williams S. , "Django for Professionals"
- Mele, Antonio, "Django 3 By Example"(第6章まで読みました)
- Greenfield, Daniel Roy, and Greenfield, Audrey Roy, "Two Scoops of Django 1.11"

##### ネット上の記事

- [Django Model Behaviors](https://blog.kevinastone.com/django-model-behaviors)
- [Testing Django Views Without Using The Test Client](https://www.ianlewis.org/en/testing-django-views-without-using-test-client)

## 反省、これまで勉強してきたこと、今後勉強したいこと

### 反省
以下、いくつかコードとアプリケーションの機能について反省点があります。
- Javascriptのコードに関してはできていません。今後はこちらもできるようにしたいです。
- またDjangoのコードに関しても、followやlikeは同じようなロジックと流れになっているので、それを抽象化してMix-inクラスを作ることで繰り返しを避けるべきでした。
- レビュー作成時に次に読むべき本の指定や推薦文を必須としました。しかし、これはユーザーにとって大きな負担になっている可能性があり、だとすれば、利用者を増やすことが難しくなり、その結果「次に何の本を読むべきかわからない」という問題を解決するプラットフォームを提供することが難しくなります。そもそも、利用者が少なくごく限られた人によって利用されるのであれば、このようなSNSは必要がなく、玉石混交の入門書の中から適切な本を選べばいいからです。そしてそれが難しいからこそ、このようなSNSで少しでも円滑に入門書などを選べる機会を提供したかったのです。従って、そのような目的は十分には達成できなかったと考えています。今後、もう少し考えたいと思います。

### 勉強してきたこと

#### webに関する基本的な知識とフロントエンド
webに関する基本的なことについては

- 小林恭平、坂本陽著、佐々木拓郎監修　『この一冊で全部わかるWeb技術の基本』　SB Creative

を読み勉強しました。

HTML, CSS, Javascriptの書籍に関しては

- たにぐちまこと、『HTML&CSS, JavaScriptのきほんのきほん』、マイナビ出版

を読みました。変数宣言する際にvarを使っていることが気になりますが、最後にはJQueryやVueなどのライブラリも紹介しており勉強になりました(ちなみに、本アプリケーションではデザインに関しては基本的にBootstrapに依拠しており、非同期通信のためだけに読み込みの遅いJQueryを使うのはデメリットが大きいと思い、axiosを使いました)。

またMdnのドキュメントも重宝しています。Mdnの"Learn Web Development"は、webの基本的な仕組みや、HTML, CSS, Javascript, npmによるJavascriptライブラリのパッケージ管理などなど勉強になりました。とりあえず、webの基本的な事柄やフロントエンドについてわからないことがあれば、ここで調べるようにしています。

React.jsに関しては公式ドキュメントのMain Conceptを一通り読んだ程度です。

#### バックエンド

英語圏ではDjangoは日本に比べて人気があり、使用している人口も多いことからなるべく早く洋書で定評のありそうな本を探しました。以下、参考になった本です。

- 横瀬　明仁、『現場で使えるDJANGOの教科書　<基本編>』

この本はチュートリアル形式でアプリを作るような入門書ではなく、Djangoを構成するview, model, middlewareなどについて基本的な知識を解説する本で、勉強になりました。また、参照している本や記事などにもきちんと言及しており、ここから次に何を読むか決めました。次に読んだのは

- Vincent, Williams S. , "Django for Beginners"
- Vincent, Williams S. , "Django for Professionals"

です。どちらもテストについて充実しており、ベストプラクティスを強調していることが良かったです。前者は、簡単なアプリケーションから始めてもうちょっと本格的なアプリケーション構築までしますが、各アプリケーションでHerokuにデプロイすることで、デプロイメントする際の心理的コストを取り除く点が、後者は、開発環境と本番環境での違いを確認したうえでのDockerの導入、信頼できるThird Partyの積極活用、セキュリティの観点から気を付けるべきことなどがプロの視点から説明されている点がとりわけ良かったです。また著者のブログも参考にしています。

- Mele, Antonio, "Django 3 By Example"

この本はユーザーフォローなどの多対多関係の構築やそれを非同期通信を用いて構築する本格的なアプリケーションを作りたいと思い購入しました。しかし、ベストプラクティスに反するなど著者の癖が強い、他の文献への参照がないこと、思った以上間違いが多いことから、第6章まで読み以降は読んでいません。それでも勉強になる点ありました。

次の本はとても勉強になりました。

- Greenfield, Daniel Roy, and Greenfield, Audrey Roy, "Two Scoops of Django 1.11"

少し古いですが、参照してる本や記事がとても多いことに加えて、設計思想といった抽象的観点からどのようにアプリケーションを構築すべきかだけではなく、Djangoの各機能が実践的観点から幅広く紹介されており、本当に勉強になりました。

#### 今後勉強したいこと